<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Les tâches</title>
  <script>
    let statuses = [
      {
        "idStatus": 1,
        "status": "A faire"
      },
      {
        "idStatus": 2,
        "status": "En cours"
      },
      {
        "idStatus": 3,
        "status": "En attente"
      },
      {
        "idStatus": 4,
        "status": "Terminé"
      },
      {
        "idStatus": 5,
        "status": "Annulé"
      },
      {
        "idStatus": 6,
        "status": "Reporté"
      }
    ]

    let priorities = [
      {
        "idPriority": 1,
        "priority": "Très basse"
      },
      {
        "idPriority": 2,
        "priority": "Basse"
      },
      {
        "idPriority": 3,
        "priority": "Moyenne"
      },
      {
        "idPriority": 4,
        "priority": "Haute"
      },
      {
        "idPriority": 5,
        "priority": "Critique"
      }
    ];

    let categories = [
      {
        "idCategory": 1,
        "category": "Perso"
      },
      {
        "idCategory": 2,
        "category": "Pro"
      },
      {
        "idCategory": 3,
        "category": "Étude"
      }
    ]

    document.onreadystatechange = function () {
      if (document.readyState == "complete") {
        init();
      }
    };

    let tasks = [];
    let statusesChecked = [];

    function init() {
      statusesChecked = statuses;
      let data = localStorage.getItem("tasks");

      if (data !== null) {
        tasks = JSON.parse(data);
      }
      displayTasks(tasks);
    }

    function displayTasks(tasks) {
      let codeHTML = "<table><tbody>";
      
      if (tasks.length === 0) {
        codeHTML = "<p>⚠️ Pas de tâche ⚠️</p>";
      } else {
        tasks.forEach((task, index) => {
          codeHTML += `
            <tr>
              <td>
                <div><b>${task.title}</b></div>
                <div class="flags">
                  <span class="flag">${priorities.find(priority => priority.idPriority === task.idPriority).priority}</span>
                  <span class="flag">${categories.find(category => category.idCategory === task.idCategory).category}</span>
                </div>
                ${task.note ? `<div>${task.note}</div>` : ""}
                ${task.tags.length > 0 ? `<div class="tags">${task.tags.join(', ')}</div>` : ""}
              </td>
              <td>
                ${Intl.DateTimeFormat("fr").format(new Date(task.dateFinished))}
              </td>
              <td>
                <button
                  class="btn${task.idStatus}"
                  onclick="openModalTaskStatus(${task.idTask})">${statuses.find(status => status.idStatus === task.idStatus).status}
                </button>
              </td>
            </tr>
          `;
        });
        codeHTML += "</tbody></table>";
      }
      document.getElementById("main").insertAdjacentHTML("afterbegin", codeHTML);
    }

    let modalTaskStatus = "";
    
    function openModalTaskStatus(id) {
      modalTaskStatus = document.getElementById("modal-task-status");
      document.getElementById("idStatus").innerHTML = "";
      statuses.forEach(function(item, index) {
        var option = document.createElement('option');
        option.value = item.idStatus;
        option.text = item.status;
        if (tasks.find(task => task.idTask === id).idStatus === item.idStatus) {
          option.setAttribute('selected', true);
        }
        document.getElementById("idStatus").append(option);
      }),

      document.querySelector('#modal-task-status button[value="close"]').setAttribute("onclick", "closeModalTaskStatus()");
      document.querySelector('#modal-task-status button[value="update"]').setAttribute("onclick", "updateTask("+ id + ")");

      modalTaskStatus.style.display = "block";
    }

    function closeModalTaskStatus() {
      modalTaskStatus.style.display = "none";
    }

    function updateTask(id) {
      tasks.find(task => task.idTask === id).idStatus = parseInt(document.getElementById("idStatus").value);
      localStorage.setItem("tasks", JSON.stringify(tasks));
      document.getElementById("main").innerHTML = "";
      init();

      modalTaskStatus.style.display = "none";
    }

    let modalStatuses = "";

    function openModalStatuses() {
      modalStatuses = document.getElementById("modal-statuses");
      const container = document.getElementById("statusCheckboxes");
      container.innerHTML = "";

      const checkedSet = new Set(statusesChecked.map(status => parseInt(status.idStatus)));
      statuses.forEach(status => {
        const wrapper = document.createElement("div");
        wrapper.classList = "status";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `status${status.idStatus}`;
        checkbox.value = status.idStatus;
        if (checkedSet.has(status.idStatus)) {
          checkbox.checked = true;
        }
        const label = document.createElement("label");
        label.setAttribute("for", checkbox.id);
        label.textContent = status.status;
        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        container.appendChild(wrapper);
      });

      document.querySelector('#modal-statuses button[value="close"]').setAttribute("onclick", "closeModalStatuses()");
      document.querySelector('#modal-statuses button[value="update"]').setAttribute("onclick", "filterStatuses()");

      modalStatuses.style.display = "block";
    }

    function closeModalStatuses(allValues) {
      modalStatuses.style.display = "none";
    }

    function filterStatuses() {
      statusesChecked = [...document.querySelectorAll(
      "#statusCheckboxes input[type='checkbox']:checked"
      )].map(cb => ({
        idStatus: cb.value,
        status: cb.nextElementSibling.textContent.trim()
      }));
      
      const checkedIds = statusesChecked.map(status => parseInt(status.idStatus));
      tasksFiltered = tasks.filter(task =>
        checkedIds.includes(task.idStatus)
      );

      document.getElementById("main").innerHTML = "";
      displayTasks(tasksFiltered);
      modalStatuses.style.display = "none";
    }

  </script>
  <style>
    body {
      max-width: 800px;
      margin: 20px auto;
      font-family: "Trebuchet MS", sans-serif;
      font-size: 14px;
    }

    .form-field {
      margin-bottom: 10px;
    }

    .form-field label {
      display: block;
      font-size: 12px;
      padding: 0 0 2.5px 5px
    }

    .form-field select {
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      border: 1px solid black;
      width: 100%;
      max-width: 135px;
      margin: 0;
      box-sizing: border-box;
    }

    table {
      table-layout: auto;
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
    }

    tr {
      box-shadow: rgba(0, 0, 0, 0.12) 0px 4px 16px;
      border-radius: 10px;
    }

    td {
      box-sizing: border-box;
      padding: 10px;
    }

    td:first-child {
      padding-right: 5px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    td:nth-child(2),
    td:nth-child(3) {
      text-align: center;
    }

    td:nth-child(2) {
      width: 80px;
      padding-right: 5px;
      padding-left: 5px;
      font-size: 12px;
    }

    td:nth-child(3) {
      width: 100px;
      padding-left: 5px;
    }

    button, .btn {
      font-size: 14px;
      text-decoration: none;
      border-radius: 5px;
      padding: 5px 10px;
      box-shadow: 0 3px 1px -2px rgba(0, 0, 0, 0.2), 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12);
      border: none;
      color: white;
      cursor: pointer;
    }

    .btn0 {
      background-color: white;
      color: black;
      border: 1px solid black;
    }

    .btn1 {
      background-color: #9CA3AF;
    }

    .btn2 {
      background-color: #3B82F6;
    }

    .btn3 {
      background-color: #F59E0B;
    }

    .btn4 {
      background-color: #10B981;
    }

    .btn5 {
      background-color: #EF4444;
    }

    .btn6 {
      background-color: #8B5CF6;
    }

    .flags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .flag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 15px;
      background-color: #eee;
      font-size: 10px;
    }

    .tags {
      font-size: 10px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      padding-top: 100px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
    }

    /* Modal Content */
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 10px;
      width: 80%;
      border-radius: 10px;
    }

    .required {
      color: #ff0000;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status label {
      padding: 0;
      font-size: 14px;
    }

  </style>
</head>
<body>
  <nav>
    <a class="btn btn0" href="savetask.html">Créer une tâche +</a>
  </nav>

  <div class="header">
    <h1>Les tâches</h1>
    <button class="btn0" onclick="openModalStatuses()">Filtrer ∇</button>
  </div>
  <section id="main"></section>
  <!-- Modal task status -->
  <div id="modal-task-status" class="modal">
    <div class="modal-content">
      <div class="form-field">
        <label for="idStatus">
          Statut
        </label>
        <select id="idStatus" name="idStatus" required>
          <option value="">--Choisir--</option>
        </select>
      </div>
      <div>
        <button class="btn5" type="button" value="close">Annuler</button>
        <button class="btn4" type="button" value="update">Valider</button>
      </div>
    </div>
  </div>

  <!-- Modal statuses -->
  <div id="modal-statuses" class="modal">
    <div class="modal-content">
      <div class="form-field">
        <label for="idStatus">
          Statuts à afficher
        </label>
        <div id="statusCheckboxes"></div>
      </div>
      <div>
        <button class="btn5" type="button" value="close">Annuler</button>
        <button class="btn4" type="button" value="update">Valider</button>
      </div>
    </div>
  </div>
</body>
</html>